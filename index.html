<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>하늘나라 보내주기 대작전</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%; overflow: hidden;
      background: url('window.webp') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Arial', sans-serif;
    }
    .page {
      width: 100vw; height: 100vh;
      position: absolute; top: 0; left: 0;
      display: none; justify-content: center; align-items: center;
    }
    .active { display: flex !important; }
    .container {
      position: relative;
      width: 70vw; max-width: 1100px;
      margin: 0 auto;
    }
    .page-img { width: 100%; height: auto; display: block; }
    .button {
      position: absolute; cursor: pointer;
      transition: transform 0.2s ease, filter 0.2s ease;
    }
    .button:hover { transform: scale(1.08); filter: brightness(1.2); }
    #btn-start { top: 58%; left: 10%; width: 350px; }
    #btn-how { top: 73%; left: 10%; width: 350px; }
    #btn-start2 { bottom: 30px; right: 40px; width: 220px; }
    #game-page {
      background: url('window.webp') no-repeat center center fixed;
      background-size: cover; z-index: 2;
    }
    #game-page .container {
      position: relative; width: 70vw;
      max-width: 1100px; margin: 0 auto;
      top: 48%; transform: translateY(-50%);
    }
    #game-bg { width: 100%; height: auto; display: block; }
    #portrait {
      position: absolute; top: 18.5%; left: 50%;
      transform: translateX(-50%); width: 40%; z-index: 2;
    }
    #send-button {
      position: absolute; bottom: 6%; right: 20%;
      width: 7%; cursor: pointer;
    }
    #like-button {
      position: absolute; bottom: 10%; right: 6%;
      width: 10%; cursor: pointer;
    }
    #percent-text {
      position: absolute;
      top: 39%; right: 8%;
      font-size: 1.2rem;
      color: #fff;
      font-weight: bold;
      text-shadow: 1px 1px 2px black;
      z-index: 5;
    }
    #user-input {
      position: absolute;
      bottom: 13%; left: 17%;
      width: 45%; height: 60px;
      font-size: 18px;
      border-radius: 8px;
      padding: 8px 12px;
      border: none;
    }
    #text-log {
      position: absolute;
      top: 45%;
      right:10%;
      width: 180px;
      height: 120px;
      overflow-y: auto;
      font-size: 14px;
      color: black;
      padding: 10px;
      background: transparent;
      border-radius: 8px;
      z-index: 999;
    }
    .floating-heart {
      position: absolute;
      animation: floatUp 2s ease-out forwards;
      pointer-events: none;
      z-index: 999;
    }
    @keyframes floatUp {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-150px); opacity: 0; }
    }
    @media (max-width: 768px) {
      .container { width: 90vw; }
      #btn-start, #btn-how, #btn-start2 { width: 180px; }
    }
  </style>
</head>
<body>

  <div id="main-page" class="page active">
    <div class="container">
      <img src="first.jpg" alt="메인 이미지" class="page-img">
      <img src="gamestart.png" id="btn-start" class="button" alt="게임 시작">
      <img src="gamehow.png" id="btn-how" class="button" alt="게임 방법">
    </div>
  </div>

  <div id="how-page" class="page">
    <div class="container">
      <img src="howtoplay_image.jpg" alt="게임 방법 이미지" class="page-img">
      <img src="gamestart2.png" id="btn-start2" class="button" alt="게임 시작">
    </div>
  </div>

  <div id="game-page" class="page">
    <div class="container">
      <img id="game-bg" src="maingame.png" alt="게임 배경">
      <img id="portrait" src="portrait1.png" alt="영정사진">
      <img id="send-button" src="send.png" alt="전송">
      <img id="like-button" src="like.png" alt="좋아요">
      <input id="user-input" type="text" placeholder="추모의 한 마디를 입력하세요">
      <div id="text-log"></div>
      <div id="percent-text">0%</div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      let percentage = 0;

      const mainPage = document.getElementById('main-page');
      const howPage = document.getElementById('how-page');
      const gamePage = document.getElementById('game-page');
      const portrait = document.getElementById('portrait');
      const percentText = document.getElementById('percent-text');
      const portraits = [
        "portrait1.png", "portrait2.png", "portrait3.png",
        "portrait4.png", "portrait5.png", "portrait6.png"
      ];

      function updatePortrait() {
        let index = 0;
        if (percentage >= 80) {
          index = 5;
          portrait.src = portraits[index];
          percentText.textContent = `${percentage}%`;

          setTimeout(() => {
            portrait.src = "last.message.png";
            setTimeout(() => {
              document.getElementById('game-bg').src = "last.image.jpg";
              portrait.style.display = 'none';

              const video = document.createElement('video');
              video.setAttribute('autoplay', true);
              video.setAttribute('playsinline', true);
              video.style.position = 'absolute';
              video.style.top = '18.5%';
              video.style.left = '50%';
              video.style.transform = 'translateX(-50%)';
              video.style.width = '40%';
              video.style.zIndex = 3;
              video.id = 'webcam-feed';
              document.querySelector('#game-page .container').appendChild(video);

              navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                  video.srcObject = stream;
                })
                .catch(err => {
                  console.error("웹캠 접근 실패:", err);
                });

            }, 3000);
          }, 2000);
        } else if (percentage >= 64) index = 4;
        else if (percentage >= 48) index = 3;
        else if (percentage >= 32) index = 2;
        else if (percentage >= 16) index = 1;

        if (percentage < 80) {
          portrait.src = portraits[index];
          percentText.textContent = `${percentage}%`;
        }
      }

      function increasePercentage() {
        if (percentage < 99) {
          percentage += 8;
          if (percentage > 99) percentage = 99;
          updatePortrait();
        }
      }

      document.getElementById('like-button').addEventListener('click', () => {
        for (let i = 0; i < 15; i++) spawnHeart();
        increasePercentage();
      });

      document.getElementById('send-button').addEventListener('click', () => {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        const log = document.getElementById('text-log');

        if (text && log) {
          const entry = document.createElement('div');
          entry.textContent = text;
          log.appendChild(entry);
          input.value = '';
          increasePercentage();
        }
      });

      function spawnHeart() {
        const heart = document.createElement('span');
        heart.className = 'floating-heart';
        heart.textContent = '❤️';
        heart.style.left = Math.random() * 90 + '%';
        heart.style.bottom = (Math.random() * 10 + 5) + '%';
        heart.style.fontSize = (Math.random() * 30 + 20) + 'px';
        heart.style.position = 'absolute';
        document.body.appendChild(heart);
        setTimeout(() => heart.remove(), 2000);
      }

      function enterFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => {
            console.warn(`전체화면 전환 실패: ${err.message}`);
          });
        }
      }

      function keepFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        }
      }

      document.addEventListener('fullscreenchange', keepFullscreen);

      document.getElementById('btn-start').addEventListener('click', () => {
        enterFullscreen();
        mainPage.classList.remove('active');
        gamePage.classList.add('active');
      });

      document.getElementById('btn-how').addEventListener('click', () => {
        mainPage.classList.remove('active');
        howPage.classList.add('active');
      });

      document.getElementById('btn-start2').addEventListener('click', () => {
        enterFullscreen();
        howPage.classList.remove('active');
        gamePage.classList.add('active');
      });

      mainPage.addEventListener('click', enterFullscreen);
    });
  </script>
</body>
</html>
